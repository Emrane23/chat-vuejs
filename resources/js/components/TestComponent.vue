<template>
    <section style="background-color: #eee;">
    <div class="container py-5">
  
      <div class="row d-flex justify-content-center">
        <div class="col-md-10 col-lg-8 col-xl-6">
  
          <div class="card" id="chat2">
            <div class="card-header d-flex justify-content-between align-items-center p-3">
              <h5 class="mb-0">Chat</h5>
              <button type="button" class="btn btn-primary btn-sm" data-mdb-ripple-color="dark">Let's Chat
                App</button>
            </div>
            <div class="card-body" data-mdb-perfect-scrollbar="true" style="position: relative;overflow: auto; height: 400px">
  
              <div class="d-flex flex-row justify-content-start">
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp"
                  alt="avatar 1" style="width: 45px; height: 100%;">
                <div>
                  <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">Hi</p>
                  <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">How are you ...???
                  </p>
                  <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">What are you doing
                    tomorrow? Can we come up a bar?</p>
                  <p class="small ms-3 mb-3 rounded-3 text-muted">23:58</p>
                </div>
              </div>
  
              <div class="divider d-flex align-items-center mb-4">
                <p class="text-center mx-3 mb-0" style="color: #a2aab7;">Today</p>
              </div>
  
              <div class="d-flex flex-row justify-content-end mb-4 pt-1">
                <div>
                  <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">Hiii, I'm good.</p>
                  <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">How are you doing?</p>
                  <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">Long time no see! Tomorrow
                    office. will
                    be free on sunday.</p>
                  <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">00:06</p>
                </div>
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp"
                  alt="avatar 1" style="width: 45px; height: 100%;">
              </div>
  
              <div class="d-flex flex-row justify-content-start mb-4">
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp"
                  alt="avatar 1" style="width: 45px; height: 100%;">
                <div>
                  <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">Okay</p>
                  <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">We will go on
                    Sunday?</p>
                  <p class="small ms-3 mb-3 rounded-3 text-muted">00:07</p>
                </div>
              </div>
  
              <div class="d-flex flex-row justify-content-end mb-4">
                <div>
                  <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">That's awesome!</p>
                  <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">I will meet you Sandon Square
                    sharp at
                    10 AM</p>
                  <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">Is that okay?</p>
                  <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">00:09</p>
                </div>
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp"
                  alt="avatar 1" style="width: 45px; height: 100%;">
              </div>
  
              <div class="d-flex flex-row justify-content-start mb-4">
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp"
                  alt="avatar 1" style="width: 45px; height: 100%;">
                <div>
                  <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">Okay i will meet
                    you on
                    Sandon Square</p>
                  <p class="small ms-3 mb-3 rounded-3 text-muted">00:11</p>
                </div>
              </div>
  
              <div class="d-flex flex-row justify-content-end mb-4">
                <div>
                  <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">Do you have pictures of Matley
                    Marriage?</p>
                  <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">00:11</p>
                </div>
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp"
                  alt="avatar 1" style="width: 45px; height: 100%;">
              </div>
  
              <div class="d-flex flex-row justify-content-start mb-4">
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp"
                  alt="avatar 1" style="width: 45px; height: 100%;">
                <div>
                  <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">Sorry I don't
                    have. i
                    changed my phone.</p>
                  <p class="small ms-3 mb-3 rounded-3 text-muted">00:13</p>
                </div>
              </div>
  
              <div class="d-flex flex-row justify-content-end">
                <div>
                  <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">Okay then see you on sunday!!
                  </p>
                  <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">00:15</p>
                </div>
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp"
                  alt="avatar 1" style="width: 45px; height: 100%;">
              </div>
  
            </div>
            <div class="card-footer text-muted d-flex justify-content-start align-items-center p-3">
              <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp"
                alt="avatar 3" style="width: 40px; height: 100%;">
              <input type="text" class="form-control form-control-lg" id="exampleFormControlInput1"
                placeholder="Type message">
              <a class="ms-1 text-muted" href="#!"><i class="fas fa-paperclip"></i></a>
              <a class="ms-3 text-muted" href="#!"><i class="fas fa-smile"></i></a>
              <a class="ms-3" href="#!"><i class="fas fa-paper-plane"></i></a>
            </div>
          </div>
  
        </div>
      </div>
  
    </div>
  </section>
  </template>
    
    <script>
  export default {
    props: ["user", "receiverid"],
    // emits: ["messagesent"],
  
    data() {
      return {
        messages: "",
        newMessage: "",
        receiver: "",
        paginate: 5,
        userTyper: false,
        typingTimer: false,
        loading: false,
      };
    },
    mounted() {
      this.scrollBottom();
      this.getReceiver();
    },
    created() {
      this.fetchMessages();
  
      Echo.join(`privatechat.${this.user.id}.${this.receiverid}`)
        .listen("PrivateMessageSent", (e) => {
          this.messages.push({
            message: e.message.message,
            sender: e.user,
          });
          document.querySelectorAll(".messages").forEach((item) => {
            item.classList.remove("new");
          });
          let newLength = this.messages.length - 1;
          let audio = new Audio("/notification/notification.mp3");
  
          if (!("Notification" in window)) {
            alert("Web Notification is not supported");
            return;
          }
          // if (e.user.name != this.user.name) {
            Notification.requestPermission((permission) => {
              let notification = new Notification("New message alert!", {
                body: e.user?.name + " has sent a message", // content for the alert
                icon: "https://www.svgrepo.com/show/31480/notification-bell.svg", // optional image url
              });
  
              // link to page on clicking the notification
              notification.onclick = () => {
                window.open(window.location.href);
              };
            });
          // }
          audio.play();
          this.scrollBottom();
          setTimeout(() => {
            document
              .querySelectorAll(".messages")
              [newLength].classList.add("new");
          }, "300");
        })
        .listenForWhisper("typing", (user) => {
          this.userTyper = user;
          if (this.typingTimer) {
            clearTimeout(this.typingTimer);
          }
          this.typingTimer = setTimeout(() => {
            this.userTyper = false;
          }, "3000");
        });
    },
  
    methods: {
      sendTypingEvent() {
        Echo.join(`privatechat.${this.receiverid}.${this.user.id}`).whisper(
          "typing",
          this.user
        );
      },
      sendMessage() {
        this.messages.push({
          sender: this.user,
          message: this.newMessage,
        });
        axios
          .post(`/privatemessages/${this.receiverid}`, {
            message: this.newMessage,
          })
          .then((response) => {});
        this.newMessage = "";
        this.scrollBottom();
      },
      getReceiver() {
        axios.get(`/getreceiver/${this.receiverid}`).then((response) => {
          this.receiver = response.data;
        });
      },
      fetchMessages() {
        axios.get(`/privatemessages/${this.receiverid}`).then((response) => {
          this.messages = response.data;
        });
      },
  
      scrollBottom() {
        var container = document.querySelector(".card-body");
        var scrollHeight = container.scrollHeight;
        var newScroll = scrollHeight + 3000;
  
        setTimeout(() => {
          container.scrollTop = newScroll;
        }, "300");
      },
  
      showMore() {
        this.paginate += 5;
        this.loading = true;
        axios
          .get(`/showmoreprivate/${this.paginate}/${this.receiverid}`)
          .then((response) => {
            console.log(response);
            this.messages = response.data;
            this.loading = false;
          })
          .catch((err) => {
            console.log(err);
          });
      },
      onScroll(e) {
        const { scrollTop, offsetHeight, scrollHeight } = e.target;
        if (scrollTop + offsetHeight >= scrollHeight) {
          // console.log("bottom!");
        }
        if (scrollTop == 0) {
          this.showMore();
        }
      },
    },
  };
  </script>
    
    <style>
  .messages.new {
    background-color: #fff;
    animation-name: MessageSent;
    -webkit-animation-name: MessageSent;
    animation-duration: 6s;
    -webkit-animation-duration: 6s;
    animation-iteration-count: 1;
    -webkit-animation-iteration-count: 1;
  }
  @keyframes MessageSent {
    from {
      background-color: rgb(241, 245, 24);
    }
    to {
      background-color: inherit;
    }
  }
  
  #chat2 .form-control {
  border-color: transparent;
  }
  
  #chat2 .form-control:focus {
  border-color: transparent;
  box-shadow: inset 0px 0px 0px 1px transparent;
  }
  
  .divider:after,
  .divider:before {
  content: "";
  flex: 1;
  height: 1px;
  background: #eee;
  }
  </style>